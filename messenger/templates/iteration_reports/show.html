{% extends "base.html" %}
{% load dictkey %}
{% load shortcut %}

{% block body %}

<div class="py-3">
    <div class="pb-3">
        <div class="text-3xl">{{ object.iteration_name }}</div>
        <div class="text-lg">Total Stories: {{ total_stories }}</div>
        <div class="text-lg">Total Points: {{ total_points }}</div>
        <div class="text-sm">Generated at: {{ object.created_at }}</div>
    </div>

    <div id="team-statistics-wrapper" class="pt-5">
        <div class="text-xl font-bold">Team Statistics</div>
        <div class="flex flex-wrap">
            <div class="w-full md:w-1/2">
                <div class="text-lg">Number of Tickets</div>
                <div>
                    <div class="flex">
                        <div class="w-1/3 font-semibold">Team</div>
                        <div class="w-1/3 font-semibold"># of Stories</div>
                        <div class="w-1/3 font-semibold">Percent</div>
                    </div>
                    {% for team, stories in stories_by_team.items %}
                    <div class="flex">
                        <div class="w-1/3">{{ team }}</div>
                        <div class="w-1/3">{{ stories|length }}</div>
                        <div class="w-1/3">{{ percent_stories_by_team|dict_key:team }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="w-full md:w-1/2 pt-2 md:pt-0">
                <div class="text-lg">Number of Points</div>
                <div>
                    <div class="flex">
                        <div class="w-1/3 font-semibold">Team</div>
                        <div class="w-1/3 font-semibold"># of Points</div>
                        <div class="w-1/3 font-semibold">Percent</div>
                    </div>
                    {% for team, points in points_by_team.items %}
                    <div class="flex">
                        <div class="w-1/3">{{ team }}</div>
                        <div class="w-1/3">{{ points }}</div>
                        <div class="w-1/3">{{ percent_points_by_team|dict_key:team }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="text-xs italic pt-2">*Tickets may belong to SMB and ENT, causing percentages to seem off.</div>
    </div>

    <div id="state-statistics-wrapper" class="pt-5">
        <div class="text-xl font-bold">State Statistics</div>
        <div class="flex flex-wrap">
            <div class="w-full md:w-1/2">
                <div class="text-lg">Number of Tickets</div>
                <div>
                    <div class="flex">
                        <div class="w-1/3 font-semibold">State</div>
                        <div class="w-1/3 font-semibold"># of Stories</div>
                        <div class="w-1/3 font-semibold">Percent</div>
                    </div>
                    {% for state, stories in stories_by_state.items %}
                    <div class="flex">
                        <div class="w-1/3">{{ state }}</div>
                        <div class="w-1/3">{{ stories|length }}</div>
                        <div class="w-1/3">{{ percent_stories_by_state|dict_key:state }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="w-full md:w-1/2 pt-2 md:pt-0">
                <div class="text-lg">Number of Points</div>
                <div>
                    <div class="flex">
                        <div class="w-1/3 font-semibold">State</div>
                        <div class="w-1/3 font-semibold"># of Points</div>
                        <div class="w-1/3 font-semibold">Percent</div>
                    </div>
                    {% for state, points in points_by_state.items %}
                    <div class="flex">
                        <div class="w-1/3">{{ state }}</div>
                        <div class="w-1/3">{{ points }}</div>
                        <div class="w-1/3">{{ percent_points_by_state|dict_key:state }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>


    <div id="high-comments-wrapper" class="pt-5">
        <div class="text-xl font-bold">Tickets Needing Information</div>
        <div class="text-gray-500">
            Tickets with a high number of comments often mean that either there was insufficient information to
            execute on the ticket or cases were uncovered after the fact.
            <br>
            A ticket falls into this category if it has more than 8 comments.
        </div>

        <div>
            <div class="flex">
                <div class="w-1/5 font-semibold">Ticket</div>
                <div class="w-3/5 font-semibold">Title</div>
                <div class="w-1/5 font-semibold"># of Comments</div>
            </div>
            {% for story_id, cnt in high_comment_stories.items %}
            <div class="flex justify-start">
                <div class="w-1/5">
                    <a href="{{ stories|dict_key:story_id|dict_key:'app_url' }}">SC-{{ story_id }}</a>
                </div>
                <div class="w-3/5">
                    {{ stories|dict_key:story_id|dict_key:'name' }}
                </div>
                <div class="w-1/5">{{ cnt }}</div>
            </div>
            {% endfor %}
        </div>

    </div>

    <div id="add-after-start-wrapper" class="pt-5">
        <div class="text-xl font-bold">Tickets Added After Iteration Started</div>
        <div>Iteration Started On: {{ iteration|dict_key:'start_date'|datetimestr|date }}</div>
        <div>
            <div class="flex">
                <div class="w-1/5 font-semibold">Ticket</div>
                <div class="w-3/5 font-semibold">Title</div>
                <div class="w-1/5 font-semibold">Added On</div>
            </div>
            {% for story_id, changed_at in added_after_start.items %}
            <div class="flex justify-start">
                <div class="w-1/5">
                    <a href="{{ stories|dict_key:story_id|dict_key:'app_url' }}">SC-{{ story_id }}</a>
                </div>
                <div class="w-3/5">
                    {{ stories|dict_key:story_id|dict_key:'name' }}
                </div>
                <div class="w-1/5">{{ changed_at|datetimestr|date }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="high-rejection-wrapper" class="pt-5">
        <div class="text-xl font-bold">Tickets with High Rejections</div>
        <div class="text-gray-500">
            Tickets with a high number of UAT rejections likely means that the Engineering team is having trouble
            getting the implementation correct on a ticket. Knowing how often this happens is important for the
            Engineering team.
            <br>
            A ticket falls into this category if the "UAT: Not Approved" label is added at least 3 times.
        </div>
        <div>
            <div class="flex">
                <div class="w-1/5 font-semibold">Ticket</div>
                <div class="w-3/5 font-semibold">Title</div>
                <div class="w-1/5 font-semibold"># of Rejections</div>
            </div>
            {% for story_id, cnt in high_uat_stories.items %}
            <div class="flex justify-start">
                <div class="w-1/5">
                    <a href="{{ stories|dict_key:story_id|dict_key:'app_url' }}">SC-{{ story_id }}</a>
                </div>
                <div class="w-3/5">
                    {{ stories|dict_key:story_id|dict_key:'name' }}
                </div>
                <div class="w-1/5">{{ cnt }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="all-rejected-wrapper" class="pt-5">
        <div class="text-xl font-bold">UAT Rejections</div>
        <div class="text-gray-500">
            A ticket falls into this category if the "UAT: Not Approved" label was ever added to it.
        </div>
        <div>
            <div class="flex">
                <div class="w-1/5 font-semibold">Ticket</div>
                <div class="w-4/5 font-semibold">Title</div>
            </div>
            {% for story_id in rejected_uat_stories %}
            <div class="flex justify-start">
                <div class="w-1/5">
                    <a href="{{ stories|dict_key:story_id|dict_key:'app_url' }}">SC-{{ story_id }}</a>
                </div>
                <div class="w-4/5">
                    {{ stories|dict_key:story_id|dict_key:'name' }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
